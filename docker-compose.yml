# 定义共享的环境变量值（使用 x- 扩展字段）
x-common-vars: &common-vars
  PGDATABASE: "mpc-dev-db"
  PGUSER: "dbuser"
  PGPASSWORD: "dbpass"
  PGHOST: "postgres"
  PGPORT: "5432"
  PGSSLMODE: "disable"
  PROJECT_ROOT_DIR: "/app"

services:
  # ============================================
  # Coordinator 节点（协调者）
  # ============================================
  coordinator:
    build:
      context: .
      target: development
    ports:
      - "8080:8080"  # HTTP API
      - "9090:9090"  # gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - vscode-extensions:/home/development/.vscode-server/extensions
      - vscode-extensions-insiders:/home/development/.vscode-server-insiders/extensions
      - bash-history:/home/development/commandhistory
      - coordinator-key-shares:/app/var/lib/mpc/key-shares
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_started
      redis:
        condition: service_started
    environment:
      # Database configuration
      <<: *common-vars
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "postgres"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Coordinator configuration
      MPC_NODE_TYPE: "coordinator"
      MPC_NODE_ID: "coordinator-1"
      MPC_CONSUL_ADDRESS: "consul:8500"
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "redis:6379"
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8080"
      SERVER_ECHO_BASE_URL: "http://coordinator:8080"
      MPC_HTTP_PORT: "8080"
      MPC_GRPC_PORT: "9090"
      MPC_TLS_ENABLED: "false"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp /app/bin /app/tmp /app/var/lib/mpc/key-shares 2>/dev/null || true
        chmod +x /app/rksh 2>/dev/null || true
        git config --global --add safe.directory /app 2>/dev/null || true
        # 构建二进制文件（如果不存在或需要更新）
        if [ ! -f /app/bin/app ] || [ internal/api/server.go -nt /app/bin/app ] || [ internal/api/wire.go -nt /app/bin/app ]; then
          echo "Building binary..."
          # 确保 Wire 代码已生成
          cd /app && go generate ./internal/api/... || echo "Wire generation skipped"
          make go-build
        fi
        # 等待数据库就绪
        echo "Waiting for database to be ready..."
        until PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c '\q' 2>/dev/null; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        # 创建数据库（如果不存在）
        echo "Checking database..."
        PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$${PGDATABASE}'" | grep -q 1 || \
          PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c "CREATE DATABASE \"$${PGDATABASE}\" WITH OWNER $${PGUSER} TEMPLATE template0;" || true
        # 运行数据库迁移（仅 coordinator 执行，避免并发问题）
        if [ "$${MPC_NODE_TYPE}" = "coordinator" ]; then
          echo "Running database migrations..."
          /app/bin/app db migrate || echo "Migration failed or already applied"
        else
          echo "Waiting for coordinator to complete migrations..."
          sleep 5
        fi
        # 启动服务器
        exec /app/bin/app server
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://localhost:8080/-/healthy?mgmt-secret=mgmtpass"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # Participant 节点 1（参与者）
  # ============================================
  participant-1:
    build:
      context: .
      target: development
    ports:
      - "8081:8081"  # HTTP API
      - "9091:9091"  # gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - participant1-key-shares:/app/var/lib/mpc/key-shares
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_started
      redis:
        condition: service_started
      coordinator:
        condition: service_started
    environment:
      <<: *common-vars
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "postgres"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Participant configuration
      MPC_NODE_TYPE: "participant"
      MPC_NODE_ID: "participant-1"
      MPC_COORDINATOR_ENDPOINT: "coordinator:9090"
      MPC_CONSUL_ADDRESS: "consul:8500"
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "redis:6379"
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8081"
      SERVER_ECHO_BASE_URL: "http://participant-1:8081"
      MPC_HTTP_PORT: "8081"
      MPC_GRPC_PORT: "9091"
      MPC_TLS_ENABLED: "false"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp /app/bin /app/tmp /app/var/lib/mpc/key-shares 2>/dev/null || true
        chmod +x /app/rksh 2>/dev/null || true
        git config --global --add safe.directory /app 2>/dev/null || true
        # 构建二进制文件（如果不存在或需要更新）
        if [ ! -f /app/bin/app ] || [ internal/api/server.go -nt /app/bin/app ] || [ internal/api/wire.go -nt /app/bin/app ]; then
          echo "Building binary..."
          # 确保 Wire 代码已生成
          cd /app && go generate ./internal/api/... || echo "Wire generation skipped"
          make go-build
        fi
        # 等待数据库就绪
        echo "Waiting for database to be ready..."
        until PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c '\q' 2>/dev/null; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        # 创建数据库（如果不存在）
        echo "Checking database..."
        PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$${PGDATABASE}'" | grep -q 1 || \
          PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c "CREATE DATABASE \"$${PGDATABASE}\" WITH OWNER $${PGUSER} TEMPLATE template0;" || true
        # 运行数据库迁移（仅 coordinator 执行，避免并发问题）
        if [ "$${MPC_NODE_TYPE}" = "coordinator" ]; then
          echo "Running database migrations..."
          /app/bin/app db migrate || echo "Migration failed or already applied"
        else
          echo "Waiting for coordinator to complete migrations..."
          sleep 5
        fi
        # 启动服务器
        exec /app/bin/app server
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://localhost:8081/-/healthy?mgmt-secret=mgmtpass"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # Participant 节点 2（参与者）
  # ============================================
  participant-2:
    build:
      context: .
      target: development
    ports:
      - "8082:8082"  # HTTP API
      - "9092:9092"  # gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - participant2-key-shares:/app/var/lib/mpc/key-shares
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_started
      redis:
        condition: service_started
      coordinator:
        condition: service_started
    environment:
      <<: *common-vars
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "postgres"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Participant configuration
      MPC_NODE_TYPE: "participant"
      MPC_NODE_ID: "participant-2"
      MPC_COORDINATOR_ENDPOINT: "coordinator:9090"
      MPC_CONSUL_ADDRESS: "consul:8500"
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "redis:6379"
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8082"
      SERVER_ECHO_BASE_URL: "http://participant-2:8082"
      MPC_HTTP_PORT: "8082"
      MPC_GRPC_PORT: "9092"
      MPC_TLS_ENABLED: "false"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp /app/bin /app/tmp /app/var/lib/mpc/key-shares 2>/dev/null || true
        chmod +x /app/rksh 2>/dev/null || true
        git config --global --add safe.directory /app 2>/dev/null || true
        # 构建二进制文件（如果不存在或需要更新）
        if [ ! -f /app/bin/app ] || [ internal/api/server.go -nt /app/bin/app ] || [ internal/api/wire.go -nt /app/bin/app ]; then
          echo "Building binary..."
          # 确保 Wire 代码已生成
          cd /app && go generate ./internal/api/... || echo "Wire generation skipped"
          make go-build
        fi
        # 等待数据库就绪
        echo "Waiting for database to be ready..."
        until PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c '\q' 2>/dev/null; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        # 创建数据库（如果不存在）
        echo "Checking database..."
        PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$${PGDATABASE}'" | grep -q 1 || \
          PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c "CREATE DATABASE \"$${PGDATABASE}\" WITH OWNER $${PGUSER} TEMPLATE template0;" || true
        # 运行数据库迁移（仅 coordinator 执行，避免并发问题）
        if [ "$${MPC_NODE_TYPE}" = "coordinator" ]; then
          echo "Running database migrations..."
          /app/bin/app db migrate || echo "Migration failed or already applied"
        else
          echo "Waiting for coordinator to complete migrations..."
          sleep 5
        fi
        # 启动服务器
        exec /app/bin/app server
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://localhost:8082/-/healthy?mgmt-secret=mgmtpass"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # Participant 节点 3（参与者）
  # ============================================
  participant-3:
    build:
      context: .
      target: development
    ports:
      - "8083:8083"  # HTTP API
      - "9093:9093"  # gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - participant3-key-shares:/app/var/lib/mpc/key-shares
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_started
      redis:
        condition: service_started
      coordinator:
        condition: service_started
    environment:
      <<: *common-vars
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "postgres"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Participant configuration
      MPC_NODE_TYPE: "participant"
      MPC_NODE_ID: "participant-3"
      MPC_COORDINATOR_ENDPOINT: "coordinator:9090"
      MPC_CONSUL_ADDRESS: "consul:8500"
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "redis:6379"
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8083"
      SERVER_ECHO_BASE_URL: "http://participant-3:8083"
      MPC_HTTP_PORT: "8083"
      MPC_GRPC_PORT: "9093"
      MPC_TLS_ENABLED: "false"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp /app/bin /app/tmp /app/var/lib/mpc/key-shares 2>/dev/null || true
        chmod +x /app/rksh 2>/dev/null || true
        git config --global --add safe.directory /app 2>/dev/null || true
        # 构建二进制文件（如果不存在或需要更新）
        if [ ! -f /app/bin/app ] || [ internal/api/server.go -nt /app/bin/app ] || [ internal/api/wire.go -nt /app/bin/app ]; then
          echo "Building binary..."
          # 确保 Wire 代码已生成
          cd /app && go generate ./internal/api/... || echo "Wire generation skipped"
          make go-build
        fi
        # 等待数据库就绪
        echo "Waiting for database to be ready..."
        until PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c '\q' 2>/dev/null; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        # 创建数据库（如果不存在）
        echo "Checking database..."
        PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$${PGDATABASE}'" | grep -q 1 || \
          PGPASSWORD=$${PGPASSWORD} psql -h $${PGHOST} -U $${PGUSER} -d postgres -c "CREATE DATABASE \"$${PGDATABASE}\" WITH OWNER $${PGUSER} TEMPLATE template0;" || true
        # 运行数据库迁移（仅 coordinator 执行，避免并发问题）
        if [ "$${MPC_NODE_TYPE}" = "coordinator" ]; then
          echo "Running database migrations..."
          /app/bin/app db migrate || echo "Migration failed or already applied"
        else
          echo "Waiting for coordinator to complete migrations..."
          sleep 5
        fi
        # 启动服务器
        exec /app/bin/app server
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://localhost:8083/-/healthy?mgmt-secret=mgmtpass"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # 基础设施服务
  # ============================================

  postgres:
    image: postgres:17.4-alpine
    # ATTENTION: These settings are for development only!
    # NEVER use fsync=off, synchronous_commit=off, full_page_writes=off in PRODUCTION
    command: "postgres -c 'shared_buffers=128MB' -c 'fsync=off' -c 'synchronous_commit=off' -c 'full_page_writes=off' -c 'max_connections=100' -c 'client_min_messages=warning'"
    expose:
      - "5432"
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: "mpc-dev-db"
      POSTGRES_USER: "dbuser"
      POSTGRES_PASSWORD: "dbpass"
    volumes:
      - pgvolume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  integresql:
    image: ghcr.io/allaboutapps/integresql:v1.1.0
    expose:
      - "5000"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: "postgres"
      PGUSER: "dbuser"
      PGPASSWORD: "dbpass"

  mailhog:
    image: mailhog/mailhog
    expose:
      - "1025"
    ports:
      - "8025:8025"

  swaggerui:
    image: swaggerapi/swagger-ui:v3.46.0
    environment:
      SWAGGER_JSON: "/api/swagger.yml"
    volumes:
      - ./api:/api:ro,consistent
      - ./api/config/swagger-ui-local-translator.js:/usr/share/nginx/configurator/translator.js:ro,delegated

  swaggerui-browser-sync:
    image: allaboutapps/browser-sync:v2.26.14
    command: start --proxy 'swaggerui:8080' --port 8081 --files "/api/*.yml"
    volumes:
      - ./api:/api:ro,consistent
    ports:
      - "8091:8081"  # 改为 8091 避免与 participant-1 冲突

  consul:
    image: consul:1.15
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: "agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -log-level=info"
    volumes:
      - consul-data:/consul/data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  # PostgreSQL data persistence
  pgvolume:

  # Consul data persistence
  consul-data:

  # Redis data persistence
  redis-data:

  # Go module cache
  go-pkg:

  # Temporary directories
  workdir-api-tmp:
  workdir-bin:
  workdir-tmp:

  # VSCode extensions cache
  vscode-extensions:
  vscode-extensions-insiders:

  # Bash history
  bash-history:

  # MPC key shares storage (每个节点独立的存储卷，确保密钥分片隔离)
  coordinator-key-shares:
  participant1-key-shares:
  participant2-key-shares:
  participant3-key-shares:
